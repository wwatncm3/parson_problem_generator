<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Parson's Problem Generator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f5f5f5; color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #4a5568; color: white; padding: 20px; text-align: center; }
        .controls { padding: 20px; background: #f7fafc; border-bottom: 1px solid #e2e8f0; text-align: center; }
        .generate-btn { background: #3182ce; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin: 0 10px; }
        .generate-btn:hover { background: #2c5aa0; }
        .problem-container { padding: 30px; }
        .problem-header { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0; }
        .problem-title { font-size: 20px; font-weight: 600; color: #2d3748; margin-bottom: 10px; }
        .problem-description { font-size: 16px; color: #4a5568; margin-bottom: 15px; }
        .info-box { background: #ebf8ff; border: 1px solid #63b3ed; border-left: 4px solid #63b3ed; padding: 12px; margin: 15px 0; border-radius: 4px; }
        .parsons-container-wrapper { display: flex; gap: 20px; margin: 20px 0; }
        .parsons-source, .parsons-target { flex: 1; min-height: 300px; border: 2px dashed #cbd5e0; border-radius: 6px; padding: 15px; }
        .parsons-target { background: #f7fafc; }
        .parsons-block { background: white; border: 1px solid #e2e8f0; border-radius: 4px; padding: 10px; margin: 8px 0; cursor: grab; font-family: 'Courier New', monospace; font-size: 14px; user-select: none; transition: all 0.2s; white-space: pre; position: relative; }
        .parsons-block:hover { background: #f7fafc; border-color: #3182ce; }
        .parsons-block:active { cursor: grabbing; }
        .parsons-block.dragging { opacity: 0.5; transform: rotate(2deg); }
        .parsons-block.indent-1 { margin-left: 20px; }
        .parsons-block.indent-2 { margin-left: 40px; }
        .parsons-block.indent-3 { margin-left: 60px; }
        .drag-hint { text-align: center; color: #718096; font-style: italic; margin: 10px 0; font-weight: 500; }
        .check-solution { background: #38a169; color: white; padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; margin: 10px 0; }
        .check-solution:hover { background: #2f855a; }
        .feedback { padding: 15px; border-radius: 6px; margin: 10px 0; font-weight: 500; }
        .feedback.correct { background: #c6f6d5; color: #22543d; border: 1px solid #38a169; }
        .feedback.incorrect { background: #fed7d7; color: #742a2a; border: 1px solid #e53e3e; }
        .solution-container { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px; margin: 15px 0; display: none; }
        .solution-container.show { display: block; }
        .solution-code { background: white; border: 1px solid #e2e8f0; border-radius: 4px; padding: 10px; font-family: 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; }
        .stats { background: #edf2f7; padding: 15px; border-radius: 6px; margin: 15px 0; text-align: center; color: #4a5568; }
        .reset-btn { background: #e53e3e; color: white; padding: 8px 16px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; margin: 5px; }
        .reset-btn:hover { background: #c53030; }
        .drop-indicator { height: 3px; background: #3182ce; margin: 4px 0; border-radius: 2px; opacity: 0; transition: opacity 0.2s; }
        .drop-indicator.show { opacity: 1; }
        .parsons-container.drag-over { border-color: #3182ce; background-color: rgba(49, 130, 206, 0.05); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêç Python Parson's Problem Generator</h1>
            <p>Generate unlimited random coding puzzles for intro Python practice</p>
        </div>

        <div class="controls">
            <button class="generate-btn" onclick="generateRandomProblem()">üé≤ Generate New Problem</button>
            <button class="generate-btn" onclick="generateEasyProblem()">üòä Easy Problem</button>
            <button class="generate-btn" onclick="generateMediumProblem()">ü§î Medium Problem</button>
            <button class="generate-btn" onclick="generateHardProblem()">üß† Hard Problem</button>
        </div>

        <div class="problem-container" id="problemContainer">
            <div class="stats">
                <p><strong>Problems Generated:</strong> <span id="problemCount">0</span> | 
                   <strong>Correct Solutions:</strong> <span id="correctCount">0</span> | 
                   <strong>Success Rate:</strong> <span id="successRate">0%</span></p>
            </div>

            <div class="problem-header">
                <h2 class="problem-title" id="problemTitle">Click "Generate New Problem" to start!</h2>
                <p class="problem-description" id="problemDescription"></p>
            </div>

            <div class="info-box" id="infoBox" style="display: none;">
                <strong>‚ÑπÔ∏è Instructions:</strong> <span id="instructions"></span>
            </div>

            <div class="parsons-container-wrapper">
                <div class="parsons-source parsons-container" id="parsonsSource">
                    <div class="drag-hint"><strong>Drag from here</strong></div>
                </div>
                <div class="parsons-target parsons-container" id="parsonsTarget">
                    <div class="drag-hint"><strong>‚Üí Drop blocks here</strong></div>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="check-solution" onclick="checkSolution()" id="checkBtn" style="display: none;">‚úÖ Check Solution</button>
                <button class="reset-btn" onclick="resetProblem()" id="resetBtn" style="display: none;">üîÑ Reset</button>
            </div>

            <div class="feedback" id="feedback" style="display: none;"></div>
            
            <div class="solution-container" id="solutionContainer">
                <h3>Correct Solution:</h3>
                <div class="solution-code" id="solutionCode"></div>
            </div>
        </div>
    </div>

    <script>
        const problemBank = [
             { difficulty: 'easy', title: 'Simple Calculator', description: 'Create code that stores two numbers, adds them together, and prints the result.', instructions: 'Arrange the blocks to add two numbers and display the sum.', blocks: ['num1 = 10', 'num2 = 25', 'result = num1 + num2', 'print(result)', 'result = num1 * num2'], solution: [{ "num1 = 10": [] }, { "num2 = 25": [] }, { "result = num1 + num2": [] }, { "print(result)": [] }] },
             { difficulty: 'easy', title: 'Greeting Message', description: 'Store a name in a variable and print a greeting message.', instructions: 'Create code that greets someone by name.', blocks: ['name = "Alice"', 'print("Hello, " + name)', 'print(name)', 'age = 20', 'print("Goodbye")'], solution: [{ 'name = "Alice"': [] }, { 'print("Hello, " + name)': [] }] },
             { difficulty: 'easy', title: 'Temperature Check', description: 'Check if the temperature is hot (above 80 degrees) and print an appropriate message.', instructions: 'Use an if statement to check temperature and print a message.', blocks: ['temp = 85', 'if temp > 80:', '    print("It\'s hot outside!")', 'if temp < 80:', '    print("It\'s cold outside!")'], solution: [{ "temp = 85": [] }, { "if temp > 80:": ["    print(\"It's hot outside!\")"] }] },
             { difficulty: 'medium', title: 'Grade Classifier', description: 'Classify a test score as Pass (>=60) or Fail (<60) and print the result.', instructions: 'Use if-else to determine pass or fail based on score.', blocks: ['score = 75', 'if score >= 60:', '    print("Pass")', 'else:', '    print("Fail")', 'if score >= 70:', '    print("Good job")'], solution: [{ "score = 75": [] }, { "if score >= 60:": ["    print(\"Pass\")"] }, { "else:": ["    print(\"Fail\")"] }] },
             { difficulty: 'medium', title: 'Shopping List Counter', description: 'Count how many items contain the letter "a" in a shopping list.', instructions: 'Loop through items and count those containing "a".', blocks: ['items = ["apple", "bread", "cheese", "banana"]', 'count = 0', 'for item in items:', '    if "a" in item:', '        count += 1', 'print(count)', 'count += 2'], solution: [{ 'items = ["apple", "bread", "cheese", "banana"]': [] }, { "count = 0": [] }, { "for item in items:": ["    if \"a\" in item:", "        count += 1"] }, { "print(count)": [] }] },
             { difficulty: 'medium', title: 'Countdown Timer', description: 'Create a countdown from 5 to 1, then print "Blast off!"', instructions: 'Use a while loop to count down from 5.', blocks: ['count = 5', 'while count > 0:', '    print(count)', '    count -= 1', 'print("Blast off!")', 'while count < 10:'], solution: [{ "count = 5": [] }, { "while count > 0:": ["    print(count)", "    count -= 1"] }, { 'print("Blast off!")': [] }] },
             { difficulty: 'hard', title: 'Password Validator', description: 'Check if a password is valid (>= 6 chars, has letters and numbers).', instructions: 'Use nested conditions to validate password strength.', blocks: ['password = "abc123"', 'if len(password) >= 6:', '    if any(c.isdigit() for c in password) and any(c.isalpha() for c in password):', '        print("Strong password")', '    else:', '        print("Weak password - must contain letters and numbers")', 'else:', '    print("Too short")', 'print("Password checked")'], solution: [{ 'password = "abc123"': [] }, { 'if len(password) >= 6:': ['    if any(c.isdigit() for c in password) and any(c.isalpha() for c in password):', '        print("Strong password")', '    else:', '        print("Weak password - must contain letters and numbers")'] }, { 'else:': ['    print("Too short")'] }] },
             { difficulty: 'hard', title: 'Student Grade Average', description: 'Calculate the average of three test scores and determine letter grade (A>=90, B>=80, C>=70, F<70).', instructions: 'Calculate average and assign letter grade based on ranges.', blocks: ['test1 = 85', 'test2 = 92', 'test3 = 78', 'average = (test1 + test2 + test3) / 3', 'if average >= 90:', '    print("A")', 'elif average >= 80:', '    print("B")', 'elif average >= 70:', '    print("C")', 'else:', '    print("F")', 'print("Grade assigned")'], solution: [{ "test1 = 85": [] }, { "test2 = 92": [] }, { "test3 = 78": [] }, { "average = (test1 + test2 + test3) / 3": [] }, { "if average >= 90:": ["    print(\"A\")"] }, { "elif average >= 80:": ["    print(\"B\")"] }, { "elif average >= 70:": ["    print(\"C\")"] }, { "else:": ["    print(\"F\")"] }] }
        ];

        let currentProblem = null;
        let problemCount = 0;
        let correctCount = 0;
        let draggedElement = null;

        function updateStats() {
            document.getElementById('problemCount').textContent = problemCount;
            document.getElementById('correctCount').textContent = correctCount;
            const rate = problemCount > 0 ? Math.round((correctCount / problemCount) * 100) : 0;
            document.getElementById('successRate').textContent = rate + '%';
        }

        const generateProblemByDifficulty = (difficulty) => {
            const filteredProblems = problemBank.filter(p => p.difficulty === difficulty);
            currentProblem = filteredProblems[Math.floor(Math.random() * filteredProblems.length)];
            displayProblem();
        };

        const generateRandomProblem = () => {
            currentProblem = problemBank[Math.floor(Math.random() * problemBank.length)];
            displayProblem();
        };
        const generateEasyProblem = () => generateProblemByDifficulty('easy');
        const generateMediumProblem = () => generateProblemByDifficulty('medium');
        const generateHardProblem = () => generateProblemByDifficulty('hard');

        function displayProblem() {
            problemCount++;
            updateStats();
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('solutionContainer').classList.remove('show');
            document.getElementById('problemTitle').textContent = currentProblem.title;
            document.getElementById('problemDescription').textContent = currentProblem.description;
            document.getElementById('instructions').textContent = currentProblem.instructions;
            document.getElementById('infoBox').style.display = 'block';
            document.getElementById('checkBtn').style.display = 'inline-block';
            document.getElementById('resetBtn').style.display = 'inline-block';

            const sourceContainer = document.getElementById('parsonsSource');
            sourceContainer.innerHTML = '<div class="drag-hint"><strong>Drag from here</strong></div>';
            
            // Shuffle and create blocks
            [...currentProblem.blocks].sort(() => Math.random() - 0.5).forEach(blockText => {
                const block = createBlock(blockText);
                sourceContainer.appendChild(block);
            });
            
            resetProblem();
        }

        function createBlock(text) {
            const block = document.createElement('div');
            block.className = 'parsons-block';
            block.textContent = text;
            block.draggable = true;
            
            // Determine indentation level
            const indentLevel = getIndentLevel(text);
            if (indentLevel > 0) {
                block.classList.add(`indent-${Math.min(indentLevel, 3)}`);
            }
            
            // Add drag event listeners
            block.addEventListener('dragstart', handleDragStart);
            block.addEventListener('dragend', handleDragEnd);
            
            return block;
        }

        function getIndentLevel(text) {
            const match = text.match(/^(\s*)/);
            const spaces = match ? match[1].length : 0;
            return Math.floor(spaces / 4); // Assuming 4 spaces per indent level
        }

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            
            // Store the original text for cloning
            e.dataTransfer.setData('text/plain', this.textContent);
            e.dataTransfer.effectAllowed = 'copyMove';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedElement = null;
            
            // Clean up any remaining drop indicators
            document.querySelectorAll('.drop-indicator').forEach(indicator => {
                indicator.remove();
            });
            
            // Remove drag-over effects
            document.querySelectorAll('.parsons-container').forEach(container => {
                container.classList.remove('drag-over');
            });
        }

        function setupDropZones() {
            const containers = document.querySelectorAll('.parsons-container');
            
            containers.forEach(container => {
                container.addEventListener('dragover', handleDragOver);
                container.addEventListener('dragenter', handleDragEnter);
                container.addEventListener('dragleave', handleDragLeave);
                container.addEventListener('drop', handleDrop);
            });
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (draggedElement && this.classList.contains('parsons-target')) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            e.preventDefault();
            // Only remove drag-over if we're actually leaving the container
            if (!this.contains(e.relatedTarget)) {
                this.classList.remove('drag-over');
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            if (!draggedElement) return;
            
            // Remove existing indicators
            this.querySelectorAll('.drop-indicator').forEach(indicator => {
                indicator.remove();
            });
            
            // Only show drop indicator in target container
            if (this.classList.contains('parsons-target')) {
                const indicator = document.createElement('div');
                indicator.className = 'drop-indicator show';
                
                const afterElement = getDragAfterElement(this, e.clientY);
                if (afterElement) {
                    this.insertBefore(indicator, afterElement);
                } else {
                    this.appendChild(indicator);
                }
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            if (!draggedElement) return;
            
            this.classList.remove('drag-over');
            
            // Remove drop indicators
            this.querySelectorAll('.drop-indicator').forEach(indicator => {
                indicator.remove();
            });
            
            // Only allow drops in target container
            if (!this.classList.contains('parsons-target')) {
                return;
            }
            
            const afterElement = getDragAfterElement(this, e.clientY);
            
            // Create new block or move existing one
            let blockToInsert;
            if (draggedElement.parentNode.classList.contains('parsons-source')) {
                // Clone from source
                blockToInsert = createBlock(draggedElement.textContent);
            } else {
                // Move within target
                blockToInsert = draggedElement;
            }
            
            // Insert the block
            if (afterElement) {
                this.insertBefore(blockToInsert, afterElement);
            } else {
                this.appendChild(blockToInsert);
            }
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.parsons-block:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function checkSolution() {
            const targetContainer = document.getElementById('parsonsTarget');
            const userBlocks = [...targetContainer.querySelectorAll('.parsons-block')];
            
            // Build user solution structure considering indentation
            const userSolution = buildSolutionStructure(userBlocks);
            
            // Debug logging
            console.log('User solution:', JSON.stringify(userSolution, null, 2));
            console.log('Expected solution:', JSON.stringify(currentProblem.solution, null, 2));
            
            // Compare structures
            const isCorrect = compareSolutions(userSolution, currentProblem.solution);
            
            const feedback = document.getElementById('feedback');
            const solutionContainer = document.getElementById('solutionContainer');
            
            if (isCorrect) {
                feedback.textContent = 'üéâ Correct! Well done!';
                feedback.className = 'feedback correct';
                correctCount++;
                updateStats();
            } else {
                feedback.textContent = '‚ùå Not quite right. Check the solution below and try again.';
                feedback.className = 'feedback incorrect';
                document.getElementById('solutionCode').textContent = formatSolution(currentProblem.solution);
                solutionContainer.classList.add('show');
            }
            feedback.style.display = 'block';
        }

        function buildSolutionStructure(blocks) {
            const solution = [];
            let i = 0;
            
            while (i < blocks.length) {
                const block = blocks[i];
                const text = block.textContent.trim();
                const cleanText = text.replace(/^\s+/, ''); // Remove leading spaces
                
                if (cleanText.endsWith(':')) {
                    // This is a parent block (like if, while, etc.)
                    const item = { [cleanText]: [] };
                    solution.push(item);
                    
                    // Look for indented children
                    i++;
                    while (i < blocks.length) {
                        const childBlock = blocks[i];
                        const childText = childBlock.textContent.trim();
                        const childCleanText = childText.replace(/^\s+/, '');
                        
                        // Check if this block is indented (has spaces) or looks indented visually
                        const isIndented = childText.startsWith('    ') || 
                                         childBlock.classList.contains('indent-1') ||
                                         childBlock.classList.contains('indent-2') ||
                                         childBlock.classList.contains('indent-3');
                        
                        if (isIndented && !childCleanText.endsWith(':')) {
                            // This is an indented child
                            item[cleanText].push(childCleanText);
                            i++;
                        } else {
                            // This block is not indented, break out to handle it as a new top-level block
                            break;
                        }
                    }
                } else {
                    // This is a regular block
                    const item = { [cleanText]: [] };
                    solution.push(item);
                    i++;
                }
            }
            
            return solution;
        }

        function compareSolutions(userSol, expectedSol) {
            if (userSol.length !== expectedSol.length) {
                console.log('Length mismatch:', userSol.length, 'vs', expectedSol.length);
                return false;
            }
            
            for (let i = 0; i < userSol.length; i++) {
                const userItem = userSol[i];
                const expectedItem = expectedSol[i];
                
                const userKey = Object.keys(userItem)[0];
                const expectedKey = Object.keys(expectedItem)[0];
                
                // Compare keys (normalize whitespace)
                const normalizedUserKey = userKey.replace(/\s+/g, ' ').trim();
                const normalizedExpectedKey = expectedKey.replace(/\s+/g, ' ').trim();
                
                if (normalizedUserKey !== normalizedExpectedKey) {
                    console.log('Key mismatch at position', i, ':', normalizedUserKey, 'vs', normalizedExpectedKey);
                    return false;
                }
                
                // Compare children arrays
                const userChildren = userItem[userKey];
                const expectedChildren = expectedItem[expectedKey];
                
                if (userChildren.length !== expectedChildren.length) {
                    console.log('Children length mismatch at', userKey, ':', userChildren.length, 'vs', expectedChildren.length);
                    return false;
                }
                
                for (let j = 0; j < userChildren.length; j++) {
                    const normalizedUserChild = userChildren[j].replace(/\s+/g, ' ').trim();
                    const normalizedExpectedChild = expectedChildren[j].replace(/\s+/g, ' ').trim();
                    
                    if (normalizedUserChild !== normalizedExpectedChild) {
                        console.log('Child mismatch at', userKey, 'position', j, ':', normalizedUserChild, 'vs', normalizedExpectedChild);
                        return false;
                    }
                }
            }
            
            return true;
        }

        function formatSolution(solutionArray) {
            let result = "";
            solutionArray.forEach(item => {
                const [key, value] = Object.entries(item)[0];
                result += key + "\n";
                if (value.length > 0) {
                    value.forEach(line => {
                        result += "    " + line + "\n";
                    });
                }
            });
            return result.trim();
        }

        function resetProblem() {
            const targetContainer = document.getElementById('parsonsTarget');
            targetContainer.innerHTML = '<div class="drag-hint"><strong>‚Üí Drop blocks here</strong></div>';
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('solutionContainer').classList.remove('show');
        }

        // Initialize the app
        window.addEventListener('load', () => {
            setupDropZones();
            generateRandomProblem();
        });
    </script>
</body>
</html>